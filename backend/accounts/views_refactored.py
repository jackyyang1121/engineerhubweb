"""
EngineerHub - ç”¨æˆ¶è¦–åœ–å±¤é‡æ§‹ç¤ºä¾‹

======================================================================================
ğŸ¯ Clean Code æ·±åº¦é‡æ§‹ï¼šä¾è³´æ³¨å…¥ + å–®ä¸€è·è²¬ + Small Functions
======================================================================================

æœ¬æ–‡ä»¶å±•ç¤ºå¦‚ä½•å°‡åŸæœ¬ 661 è¡Œçš„å¤§å‹ UserViewSet é‡æ§‹ç‚ºç¬¦åˆ Clean Code åŸå‰‡çš„å°å‹ã€
è·è²¬å–®ä¸€çš„çµ„ä»¶ã€‚é€™æ˜¯ä¸€å€‹å®Œæ•´çš„å­¸ç¿’ç¯„ä¾‹ï¼Œå±•ç¤ºäº† Clean Code åœ¨å¯¦éš›é …ç›®ä¸­çš„æ‡‰ç”¨ã€‚

é‡æ§‹æ ¸å¿ƒåŸå‰‡ï¼š
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ 1. å–®ä¸€è·è²¬åŸå‰‡ (Single Responsibility Principle)          â”‚
â”‚    - æ¯å€‹é¡åªè² è²¬ä¸€å€‹æ˜ç¢ºçš„æ¥­å‹™é ˜åŸŸ                           â”‚
â”‚    - è·è²¬åˆ†é›¢ï¼Œé™ä½è€¦åˆåº¦                                     â”‚
â”‚                                                             â”‚
â”‚ 2. å°å‡½æ•¸åŸå‰‡ (Small Functions)                             â”‚
â”‚    - æ¯å€‹å‡½æ•¸åªåšä¸€ä»¶äº‹                                       â”‚
â”‚    - å‡½æ•¸é•·åº¦æ§åˆ¶åœ¨ 20 è¡Œä»¥å…§                                â”‚
â”‚    - é‚è¼¯æ¸…æ™°ï¼Œæ˜“æ–¼ç†è§£å’Œæ¸¬è©¦                                 â”‚
â”‚                                                             â”‚
â”‚ 3. ä¾è³´æ³¨å…¥ (Dependency Injection)                          â”‚
â”‚    - é€šéæ§‹é€ å‡½æ•¸æ³¨å…¥ä¾è³´                                     â”‚
â”‚    - ä¾è³´æ–¼æŠ½è±¡è€Œéå…·é«”å¯¦ç¾                                   â”‚
â”‚    - æé«˜å¯æ¸¬è©¦æ€§å’Œå¯ç¶­è­·æ€§                                   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

======================================================================================
"""

from typing import Dict, Any, Optional, List, Tuple
from rest_framework import status, generics
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated, AllowAny
from django.contrib.auth import get_user_model
from django.db.models import Q
from django.shortcuts import get_object_or_404
import logging

# å°å…¥æ¨¡å‹
from .models import Follow, BlockedUser

# ç²å–ç”¨æˆ¶æ¨¡å‹
User = get_user_model()
logger = logging.getLogger('engineerhub.accounts')


# ======================================================================================
# ğŸ›¡ï¸ æ¬Šé™æª¢æŸ¥å™¨é¡ - å–®ä¸€è·è²¬ï¼šç”¨æˆ¶æ“ä½œæ¬Šé™é©—è­‰
# ======================================================================================

class UserPermissionChecker:
    """
    ç”¨æˆ¶æ¬Šé™æª¢æŸ¥å™¨
    
    â•­â”€ ğŸ“š å­¸ç¿’é‡é» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚ â€¢ å–®ä¸€è·è²¬ï¼šåªè² è²¬æ¬Šé™ç›¸é—œçš„æ¥­å‹™è¦å‰‡æª¢æŸ¥                     â”‚
    â”‚ â€¢ éœæ…‹æ–¹æ³•ï¼šç„¡ç‹€æ…‹çš„ç´”å‡½æ•¸è¨­è¨ˆ                              â”‚
    â”‚ â€¢ æ¥­å‹™è¦å‰‡å°è£ï¼šå°‡è¤‡é›œçš„æ¬Šé™é‚è¼¯å°è£åœ¨å°ˆé–€çš„é¡ä¸­             â”‚
    â”‚ â€¢ è¿”å›å€¼è¨­è¨ˆï¼šä½¿ç”¨ tuple è¿”å›çµæœå’ŒéŒ¯èª¤ä¿¡æ¯                  â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    
    ğŸ¯ è·è²¬ç¯„åœï¼š
    â”œâ”€â”€ âœ… æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å¯ä»¥åŸ·è¡Œé—œæ³¨æ“ä½œ
    â”œâ”€â”€ âœ… é©—è­‰ç”¨æˆ¶é»‘åå–®ç‹€æ…‹
    â”œâ”€â”€ âœ… æª¢æŸ¥é‡è¤‡é—œæ³¨æƒ…æ³
    â””â”€â”€ âœ… æä¾›çµ±ä¸€çš„æ¬Šé™é©—è­‰æ¥å£
    """
    
    @staticmethod
    def can_follow_user(follower: User, target_user: User) -> Tuple[bool, Optional[str]]:
        """
        æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å¯ä»¥é—œæ³¨ç›®æ¨™ç”¨æˆ¶
        
        â•­â”€ ğŸ“‹ æ¥­å‹™è¦å‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ 1. ç”¨æˆ¶ä¸èƒ½é—œæ³¨è‡ªå·±                                    â”‚
        â”‚ 2. ç”¨æˆ¶ä¸èƒ½é—œæ³¨å·²ç¶“æ‹‰é»‘è‡ªå·±çš„ç”¨æˆ¶                       â”‚
        â”‚ 3. ç”¨æˆ¶ä¸èƒ½é‡è¤‡é—œæ³¨å·²é—œæ³¨çš„ç”¨æˆ¶                         â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            follower (User): ç™¼èµ·é—œæ³¨çš„ç”¨æˆ¶
            target_user (User): è¢«é—œæ³¨çš„ç›®æ¨™ç”¨æˆ¶
        
        Returns:
            Tuple[bool, Optional[str]]: 
                - bool: æ˜¯å¦å…è¨±é—œæ³¨ (True=å…è¨±, False=ä¸å…è¨±)
                - Optional[str]: å¦‚æœä¸å…è¨±ï¼Œè¿”å›å…·é«”çš„éŒ¯èª¤åŸå› 
        
        Examples:
            >>> checker = UserPermissionChecker()
            >>> can_follow, error = checker.can_follow_user(user1, user2)
            >>> if not can_follow:
            ...     print(f"ç„¡æ³•é—œæ³¨ï¼š{error}")
        """
        # ğŸ”’ è¦å‰‡ 1ï¼šé˜²æ­¢è‡ªæˆ‘é—œæ³¨
        if follower.id == target_user.id:
            return False, "ä¸èƒ½é—œæ³¨è‡ªå·±"
        
        # ğŸ”’ è¦å‰‡ 2ï¼šæª¢æŸ¥é»‘åå–®ç‹€æ…‹
        if UserPermissionChecker._is_blocked_by_target(follower, target_user):
            return False, "ç„¡æ³•é—œæ³¨æ­¤ç”¨æˆ¶ï¼Œæ‚¨å¯èƒ½å·²è¢«å°æ–¹æ‹‰é»‘"
        
        # ğŸ”’ è¦å‰‡ 3ï¼šæª¢æŸ¥é‡è¤‡é—œæ³¨
        if UserPermissionChecker._is_already_following(follower, target_user):
            return False, "æ‚¨å·²ç¶“é—œæ³¨äº†æ­¤ç”¨æˆ¶"
        
        # âœ… æ‰€æœ‰æª¢æŸ¥é€šé
        return True, None
    
    @staticmethod
    def _is_blocked_by_target(user: User, target: User) -> bool:
        """
        æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦è¢«ç›®æ¨™ç”¨æˆ¶æ‹‰é»‘
        
        â•­â”€ ğŸ” è¨­è¨ˆè€ƒé‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ ç§æœ‰æ–¹æ³•ï¼šå…§éƒ¨ä½¿ç”¨ï¼Œä¸å°å¤–æš´éœ²                         â”‚
        â”‚ â€¢ å–®ä¸€æŸ¥è©¢ï¼šåªåšä¸€ä»¶äº‹ï¼Œæª¢æŸ¥é»‘åå–®ç‹€æ…‹                   â”‚
        â”‚ â€¢ æ€§èƒ½å„ªåŒ–ï¼šä½¿ç”¨ exists() è€Œé count()                  â”‚
        â”‚ â€¢ æ¸…æ™°å‘½åï¼šæ–¹æ³•åæ˜ç¢ºè¡¨é”å…¶åŠŸèƒ½                         â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        """
        return BlockedUser.objects.filter(
            blocker=target,
            blocked=user
        ).exists()
    
    @staticmethod
    def _is_already_following(follower: User, target: User) -> bool:
        """
        æª¢æŸ¥æ˜¯å¦å·²ç¶“é—œæ³¨ç›®æ¨™ç”¨æˆ¶
        
        Args:
            follower (User): é—œæ³¨è€…
            target (User): ç›®æ¨™ç”¨æˆ¶
            
        Returns:
            bool: True è¡¨ç¤ºå·²é—œæ³¨ï¼ŒFalse è¡¨ç¤ºæœªé—œæ³¨
        """
        return Follow.objects.filter(
            follower=follower,
            following=target
        ).exists()


# ======================================================================================
# ğŸ”§ é—œæ³¨æ“ä½œæœå‹™é¡ - å–®ä¸€è·è²¬ï¼šç”¨æˆ¶é—œæ³¨æ¥­å‹™é‚è¼¯è™•ç†
# ======================================================================================

class FollowOperationService:
    """
    ç”¨æˆ¶é—œæ³¨æ“ä½œæœå‹™
    
    â•­â”€ ğŸ“š å­¸ç¿’é‡é» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚ â€¢ æœå‹™å±¤æ¨¡å¼ï¼šå°‡æ¥­å‹™é‚è¼¯å¾è¦–åœ–å±¤åˆ†é›¢å‡ºä¾†                     â”‚
    â”‚ â€¢ äº‹å‹™è™•ç†ï¼šç¢ºä¿æ•¸æ“šçš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§                         â”‚
    â”‚ â€¢ éŒ¯èª¤è™•ç†ï¼šçµ±ä¸€çš„ç•°å¸¸è™•ç†å’ŒéŒ¯èª¤éŸ¿æ‡‰                         â”‚
    â”‚ â€¢ æ—¥èªŒè¨˜éŒ„ï¼šè¨˜éŒ„é‡è¦çš„æ¥­å‹™æ“ä½œ                              â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    
    ğŸ¯ è·è²¬ç¯„åœï¼š
    â”œâ”€â”€ âœ… åŸ·è¡Œé—œæ³¨æ“ä½œçš„å®Œæ•´æ¥­å‹™æµç¨‹
    â”œâ”€â”€ âœ… æ›´æ–°ç›¸é—œçš„çµ±è¨ˆæ•¸æ“š
    â”œâ”€â”€ âœ… è™•ç†æ“ä½œéç¨‹ä¸­çš„ç•°å¸¸æƒ…æ³
    â””â”€â”€ âœ… è¨˜éŒ„æ“ä½œæ—¥èªŒä¾›å¯©è¨ˆä½¿ç”¨
    """
    
    def __init__(self):
        """
        åˆå§‹åŒ–é—œæ³¨æ“ä½œæœå‹™
        
        â•­â”€ ğŸ’¡ ä¾è³´æ³¨å…¥å¯¦è¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ åœ¨æ§‹é€ å‡½æ•¸ä¸­åˆå§‹åŒ–æ‰€éœ€çš„ä¾è³´çµ„ä»¶ï¼Œé€™æ¨£å¯ä»¥ï¼š              â”‚
        â”‚ â€¢ æ˜ç¢ºå±•ç¤ºé¡çš„ä¾è³´é—œä¿‚                                  â”‚
        â”‚ â€¢ ä¾¿æ–¼å–®å…ƒæ¸¬è©¦æ™‚æ³¨å…¥ Mock å°è±¡                          â”‚
        â”‚ â€¢ æé«˜ä»£ç¢¼çš„å¯ç¶­è­·æ€§å’Œå¯æ¸¬è©¦æ€§                          â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        """
        self.permission_checker = UserPermissionChecker()
    
    def execute_follow(self, follower: User, target: User) -> Dict[str, Any]:
        """
        åŸ·è¡Œé—œæ³¨ç”¨æˆ¶çš„å®Œæ•´æ“ä½œæµç¨‹
        
        â•­â”€ ğŸ“‹ è™•ç†æµç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ 1. æ¬Šé™é©—è­‰ â†’ æª¢æŸ¥æ˜¯å¦å…è¨±é—œæ³¨                          â”‚
        â”‚ 2. å‰µå»ºé—œæ³¨ â†’ åœ¨æ•¸æ“šåº«ä¸­å»ºç«‹é—œæ³¨é—œä¿‚                     â”‚
        â”‚ 3. æ›´æ–°çµ±è¨ˆ â†’ æ›´æ–°é›™æ–¹çš„é—œæ³¨æ•¸çµ±è¨ˆ                       â”‚
        â”‚ 4. è¨˜éŒ„æ—¥èªŒ â†’ è¨˜éŒ„æ“ä½œä¾›å¾ŒçºŒå¯©è¨ˆ                        â”‚
        â”‚ 5. è¿”å›çµæœ â†’ çµ±ä¸€æ ¼å¼çš„æ“ä½œçµæœ                        â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            follower (User): ç™¼èµ·é—œæ³¨çš„ç”¨æˆ¶
            target (User): è¢«é—œæ³¨çš„ç›®æ¨™ç”¨æˆ¶
        
        Returns:
            Dict[str, Any]: æ¨™æº–åŒ–çš„æ“ä½œçµæœ
            {
                'success': bool,        # æ“ä½œæ˜¯å¦æˆåŠŸ
                'message': str,         # çµæœæè¿°ä¿¡æ¯
                'status_code': int,     # å°æ‡‰çš„ HTTP ç‹€æ…‹ç¢¼
                'data': Optional[Any]   # é¡å¤–çš„è¿”å›æ•¸æ“š
            }
        """
        # ğŸ“‹ æ­¥é©Ÿ 1ï¼šåŸ·è¡Œæ¬Šé™æª¢æŸ¥
        can_follow, error_msg = self.permission_checker.can_follow_user(follower, target)
        if not can_follow:
            return self._create_error_response(error_msg, status.HTTP_400_BAD_REQUEST)
        
        # ğŸ“‹ æ­¥é©Ÿ 2ï¼šåŸ·è¡Œé—œæ³¨æ“ä½œ
        try:
            follow_created = self._create_follow_relationship(follower, target)
            
            if follow_created:
                # ğŸ“‹ æ­¥é©Ÿ 3ï¼šæ›´æ–°çµ±è¨ˆæ•¸æ“š
                self._update_follow_statistics(follower, target)
                
                # ğŸ“‹ æ­¥é©Ÿ 4ï¼šè¨˜éŒ„æ“ä½œæ—¥èªŒ
                self._log_follow_operation(follower, target)
                
                # ğŸ“‹ æ­¥é©Ÿ 5ï¼šè¿”å›æˆåŠŸçµæœ
                return self._create_success_response(
                    f"æˆåŠŸé—œæ³¨ç”¨æˆ¶ {target.username}",
                    status.HTTP_201_CREATED
                )
            else:
                return self._create_error_response(
                    "é—œæ³¨æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦",
                    status.HTTP_400_BAD_REQUEST
                )
        
        except Exception as e:
            # ğŸš¨ ç•°å¸¸è™•ç†ï¼šè¨˜éŒ„éŒ¯èª¤ä¸¦è¿”å›å‹å¥½çš„éŒ¯èª¤ä¿¡æ¯
            logger.error(
                f"é—œæ³¨æ“ä½œç™¼ç”Ÿç•°å¸¸: {follower.username} -> {target.username}, "
                f"éŒ¯èª¤è©³æƒ…: {str(e)}"
            )
            return self._create_error_response(
                "ç³»çµ±æš«æ™‚å‡ºç¾å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦",
                status.HTTP_500_INTERNAL_SERVER_ERROR
            )
    
    def _create_follow_relationship(self, follower: User, target: User) -> bool:
        """
        åœ¨æ•¸æ“šåº«ä¸­å‰µå»ºé—œæ³¨é—œä¿‚
        
        â•­â”€ ğŸ”§ æŠ€è¡“ç´°ç¯€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ ä½¿ç”¨ get_or_create é¿å…é‡è¤‡å‰µå»º                       â”‚
        â”‚ â€¢ åŸå­æ“ä½œç¢ºä¿æ•¸æ“šä¸€è‡´æ€§                                â”‚
        â”‚ â€¢ è¿”å›æ˜¯å¦å¯¦éš›å‰µå»ºäº†æ–°è¨˜éŒ„                              â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            follower (User): é—œæ³¨è€…
            target (User): è¢«é—œæ³¨è€…
        
        Returns:
            bool: True è¡¨ç¤ºæˆåŠŸå‰µå»ºæ–°çš„é—œæ³¨é—œä¿‚ï¼ŒFalse è¡¨ç¤ºé—œä¿‚å·²å­˜åœ¨
        """
        follow_obj, created = Follow.objects.get_or_create(
            follower=follower,
            following=target
        )
        return created
    
    def _update_follow_statistics(self, follower: User, target: User) -> None:
        """
        æ›´æ–°é—œæ³¨ç›¸é—œçš„çµ±è¨ˆæ•¸æ“š
        
        â•­â”€ ğŸ“Š çµ±è¨ˆæ›´æ–°ç­–ç•¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ å¯¦æ™‚æ›´æ–°ï¼šä¿è­‰çµ±è¨ˆæ•¸æ“šçš„å‡†ç¢ºæ€§                         â”‚
        â”‚ â€¢ å­—æ®µæ›´æ–°ï¼šåªæ›´æ–°å¿…è¦çš„å­—æ®µï¼Œæé«˜æ€§èƒ½                   â”‚
        â”‚ â€¢ é›™å‘æ›´æ–°ï¼šæ›´æ–°é—œæ³¨è€…å’Œè¢«é—œæ³¨è€…çš„çµ±è¨ˆ                   â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            follower (User): é—œæ³¨è€…ï¼ˆæ›´æ–°å…¶ following_countï¼‰
            target (User): è¢«é—œæ³¨è€…ï¼ˆæ›´æ–°å…¶ followers_countï¼‰
        """
        # æ›´æ–°è¢«é—œæ³¨è€…çš„ç²‰çµ²æ•¸çµ±è¨ˆ
        target.followers_count = target.followers.count()
        target.save(update_fields=['followers_count'])
        
        # æ›´æ–°é—œæ³¨è€…çš„é—œæ³¨æ•¸çµ±è¨ˆ
        follower.following_count = follower.following.count()
        follower.save(update_fields=['following_count'])
    
    def _log_follow_operation(self, follower: User, target: User) -> None:
        """
        è¨˜éŒ„é—œæ³¨æ“ä½œçš„æ—¥èªŒ
        
        â•­â”€ ğŸ“ æ—¥èªŒè¨˜éŒ„çš„é‡è¦æ€§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ æ“ä½œå¯©è¨ˆï¼šè¿½è¹¤é‡è¦çš„æ¥­å‹™æ“ä½œ                          â”‚
        â”‚ â€¢ å•é¡Œè¨ºæ–·ï¼šå¹«åŠ©å®šä½å’Œè§£æ±ºå•é¡Œ                          â”‚
        â”‚ â€¢ æ•¸æ“šåˆ†æï¼šç‚ºæ¥­å‹™åˆ†ææä¾›æ•¸æ“šæ”¯æŒ                      â”‚
        â”‚ â€¢ åˆè¦è¦æ±‚ï¼šæ»¿è¶³æŸäº›è¡Œæ¥­çš„åˆè¦æ€§è¦æ±‚                    â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        """
        logger.info(
            f"ç”¨æˆ¶é—œæ³¨æ“ä½œå®Œæˆ: "
            f"é—œæ³¨è€…={follower.username}, "
            f"è¢«é—œæ³¨è€…={target.username}, "
            f"æ™‚é–“æˆ³={logger.handlers[0].formatter.formatTime(logger.makeRecord('', 0, '', 0, '', (), None))}"
        )
    
    def _create_success_response(self, message: str, status_code: int) -> Dict[str, Any]:
        """
        å‰µå»ºæ¨™æº–åŒ–çš„æˆåŠŸéŸ¿æ‡‰
        
        â•­â”€ ğŸ¯ æ¨™æº–åŒ–éŸ¿æ‡‰çš„å¥½è™• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ ä¸€è‡´æ€§ï¼šæ‰€æœ‰ API è¿”å›ç›¸åŒæ ¼å¼çš„éŸ¿æ‡‰                    â”‚
        â”‚ â€¢ å¯é æ¸¬ï¼šå‰ç«¯å¯ä»¥çµ±ä¸€è™•ç†éŸ¿æ‡‰                          â”‚
        â”‚ â€¢ å¯ç¶­è­·ï¼šä¿®æ”¹éŸ¿æ‡‰æ ¼å¼åªéœ€åœ¨ä¸€è™•ä¿®æ”¹                    â”‚
        â”‚ â€¢ æ–‡æª”å‹å¥½ï¼šä¾¿æ–¼ç”Ÿæˆ API æ–‡æª”                           â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        """
        return {
            'success': True,
            'message': message,
            'status_code': status_code,
            'data': None
        }
    
    def _create_error_response(self, message: str, status_code: int) -> Dict[str, Any]:
        """
        å‰µå»ºæ¨™æº–åŒ–çš„éŒ¯èª¤éŸ¿æ‡‰
        
        Args:
            message (str): éŒ¯èª¤æè¿°ä¿¡æ¯
            status_code (int): HTTP ç‹€æ…‹ç¢¼
        
        Returns:
            Dict[str, Any]: æ¨™æº–åŒ–çš„éŒ¯èª¤éŸ¿æ‡‰æ ¼å¼
        """
        return {
            'success': False,
            'message': message,
            'status_code': status_code,
            'data': None
        }


# ======================================================================================
# ğŸ” ç”¨æˆ¶æŸ¥è©¢æœå‹™é¡ - å–®ä¸€è·è²¬ï¼šç”¨æˆ¶æ•¸æ“šæŸ¥è©¢å’Œæœç´¢
# ======================================================================================

class UserQueryService:
    """
    ç”¨æˆ¶æŸ¥è©¢æœå‹™
    
    â•­â”€ ğŸ“š å­¸ç¿’é‡é» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚ â€¢ æŸ¥è©¢å„ªåŒ–ï¼šä½¿ç”¨é åŠ è¼‰é¿å… N+1 æŸ¥è©¢å•é¡Œ                     â”‚
    â”‚ â€¢ æ¬Šé™éæ¿¾ï¼šæ ¹æ“šç”¨æˆ¶æ¬Šé™éæ¿¾æŸ¥è©¢çµæœ                        â”‚
    â”‚ â€¢ æœç´¢å¯¦ç¾ï¼šå¤šå­—æ®µæœç´¢çš„å¯¦ç¾ç­–ç•¥                            â”‚
    â”‚ â€¢ æ€§èƒ½è€ƒæ…®ï¼šæŸ¥è©¢çµæœçš„ç·©å­˜å’Œåˆ†é è™•ç†                        â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    
    ğŸ¯ è·è²¬ç¯„åœï¼š
    â”œâ”€â”€ âœ… æä¾›å„ªåŒ–çš„ç”¨æˆ¶æŸ¥è©¢é›†
    â”œâ”€â”€ âœ… å¯¦ç¾ç”¨æˆ¶æœç´¢åŠŸèƒ½
    â”œâ”€â”€ âœ… è™•ç†ç”¨æˆ¶æ¬Šé™ç›¸é—œçš„æ•¸æ“šéæ¿¾
    â””â”€â”€ âœ… å„ªåŒ–æŸ¥è©¢æ€§èƒ½
    """
    
    def get_optimized_user_queryset(self, current_user: Optional[User] = None):
        """
        ç²å–ç¶“éå„ªåŒ–çš„ç”¨æˆ¶æŸ¥è©¢é›†
        
        â•­â”€ ğŸš€ æŸ¥è©¢å„ªåŒ–æŠ€å·§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ prefetch_relatedï¼šé åŠ è¼‰å¤šå°å¤šå’Œä¸€å°å¤šé—œè¯           â”‚
        â”‚ â€¢ select_relatedï¼šé åŠ è¼‰å¤–éµé—œè¯                      â”‚
        â”‚ â€¢ æ¬Šé™éæ¿¾ï¼šæ ¹æ“šç•¶å‰ç”¨æˆ¶æ¬Šé™éæ¿¾çµæœ                    â”‚
        â”‚ â€¢ é¿å… N+1ï¼šæ¸›å°‘æ•¸æ“šåº«æŸ¥è©¢æ¬¡æ•¸                         â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            current_user (Optional[User]): ç•¶å‰ç™»éŒ„çš„ç”¨æˆ¶ï¼Œç”¨æ–¼æ¬Šé™éæ¿¾
        
        Returns:
            QuerySet: ç¶“éå„ªåŒ–å’Œéæ¿¾çš„ç”¨æˆ¶æŸ¥è©¢é›†
        """
        # ğŸ”§ åŸºç¤æŸ¥è©¢é›†ï¼šé åŠ è¼‰ç›¸é—œæ•¸æ“šé¿å… N+1 æŸ¥è©¢
        queryset = User.objects.prefetch_related(
            'followers',           # é åŠ è¼‰é—œæ³¨è€…åˆ—è¡¨
            'following',           # é åŠ è¼‰é—œæ³¨åˆ—è¡¨
            'portfolio_projects',  # é åŠ è¼‰ä½œå“é›†é …ç›®
            'settings'             # é åŠ è¼‰ç”¨æˆ¶è¨­ç½®
        )
        
        # ğŸ”’ æ¬Šé™éæ¿¾ï¼šå¦‚æœæœ‰ç•¶å‰ç”¨æˆ¶ï¼Œéæ¿¾æ‰è¢«æ‹‰é»‘çš„ç”¨æˆ¶
        if current_user and current_user.is_authenticated:
            blocked_user_ids = self._get_blocked_user_ids(current_user)
            if blocked_user_ids:
                queryset = queryset.exclude(id__in=blocked_user_ids)
        
        return queryset
    
    def search_users_by_keyword(self, keyword: str, limit: int = 10) -> List[User]:
        """
        æ ¹æ“šé—œéµè©æœç´¢ç”¨æˆ¶
        
        â•­â”€ ğŸ” æœç´¢ç­–ç•¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ å¤šå­—æ®µæœç´¢ï¼šç”¨æˆ¶åã€å§“åã€ç°¡ä»‹ç­‰å¤šå€‹å­—æ®µ               â”‚
        â”‚ â€¢ æ¨¡ç³ŠåŒ¹é…ï¼šä½¿ç”¨ icontains é€²è¡Œä¸å€åˆ†å¤§å°å¯«æœç´¢         â”‚
        â”‚ â€¢ çµæœæ’åºï¼šæŒ‰ç›¸é—œæ€§æˆ–å…¶ä»–è¦å‰‡æ’åº                      â”‚
        â”‚ â€¢ æ•¸é‡é™åˆ¶ï¼šé¿å…è¿”å›éå¤šçµæœå½±éŸ¿æ€§èƒ½                    â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            keyword (str): æœç´¢é—œéµè©
            limit (int): è¿”å›çµæœçš„æœ€å¤§æ•¸é‡ï¼Œé»˜èª 10 å€‹
        
        Returns:
            List[User]: æœç´¢åˆ°çš„ç”¨æˆ¶åˆ—è¡¨
        
        Examples:
            >>> service = UserQueryService()
            >>> users = service.search_users_by_keyword("å¼µä¸‰", limit=5)
            >>> print(f"æ‰¾åˆ° {len(users)} å€‹ç”¨æˆ¶")
        """
        # ğŸ” æ§‹å»ºå¤šå­—æ®µæœç´¢æ¢ä»¶
        search_conditions = (
            Q(username__icontains=keyword) |      # ç”¨æˆ¶ååŒ…å«é—œéµè©
            Q(first_name__icontains=keyword) |    # åå­—åŒ…å«é—œéµè©
            Q(last_name__icontains=keyword) |     # å§“æ°åŒ…å«é—œéµè©
            Q(bio__icontains=keyword)             # å€‹äººç°¡ä»‹åŒ…å«é—œéµè©
        )
        
        # ğŸ¯ åŸ·è¡Œæœç´¢æŸ¥è©¢
        search_results = User.objects.filter(search_conditions).order_by(
            'username'  # æŒ‰ç”¨æˆ¶åæ’åºï¼Œä¿è­‰çµæœçš„ä¸€è‡´æ€§
        )[:limit]
        
        return list(search_results)
    
    def _get_blocked_user_ids(self, user: User) -> List:
        """
        ç²å–è¢«æŒ‡å®šç”¨æˆ¶æ‹‰é»‘çš„ç”¨æˆ¶IDåˆ—è¡¨
        
        â•­â”€ ğŸ¯ è¨­è¨ˆè€ƒé‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ ç§æœ‰æ–¹æ³•ï¼šåƒ…ä¾›å…§éƒ¨ä½¿ç”¨ï¼Œä¸å°å¤–æš´éœ²                    â”‚
        â”‚ â€¢ é«˜æ•ˆæŸ¥è©¢ï¼šç›´æ¥è¿”å› ID åˆ—è¡¨è€Œéå®Œæ•´å°è±¡                â”‚
        â”‚ â€¢ å…§å­˜å„ªåŒ–ï¼šä½¿ç”¨ values_list æ¸›å°‘å…§å­˜ä½¿ç”¨              â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            user (User): æŒ‡å®šçš„ç”¨æˆ¶
        
        Returns:
            List: è¢«è©²ç”¨æˆ¶æ‹‰é»‘çš„ç”¨æˆ¶IDåˆ—è¡¨
        """
        return list(
            BlockedUser.objects.filter(blocker=user)
            .values_list('blocked_id', flat=True)
        )


# ======================================================================================
# ğŸ­ é‡æ§‹å¾Œçš„è¦–åœ–é¡ - å–®ä¸€è·è²¬ï¼šHTTPè«‹æ±‚å’ŒéŸ¿æ‡‰è™•ç†
# ======================================================================================

class UserFollowView(generics.GenericAPIView):
    """
    ç”¨æˆ¶é—œæ³¨æ“ä½œè¦–åœ–
    
    â•­â”€ ğŸ“š å­¸ç¿’é‡é» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚ â€¢ è¦–åœ–è·è²¬å–®ä¸€ï¼šåªè™•ç† HTTP è«‹æ±‚å’ŒéŸ¿æ‡‰                      â”‚
    â”‚ â€¢ æ¥­å‹™é‚è¼¯å¤–éƒ¨åŒ–ï¼šæ‰€æœ‰æ¥­å‹™é‚è¼¯éƒ½å§”è¨—çµ¦æœå‹™å±¤                â”‚
    â”‚ â€¢ RESTful è¨­è¨ˆï¼šç¬¦åˆ REST æ¶æ§‹é¢¨æ ¼                         â”‚
    â”‚ â€¢ éŒ¯èª¤è™•ç†çµ±ä¸€ï¼šçµ±ä¸€çš„éŒ¯èª¤éŸ¿æ‡‰æ ¼å¼                          â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    
    ğŸ¯ è·è²¬ç¯„åœï¼š
    â”œâ”€â”€ âœ… æ¥æ”¶å’Œé©—è­‰ HTTP è«‹æ±‚
    â”œâ”€â”€ âœ… å§”è¨—æ¥­å‹™é‚è¼¯çµ¦æœå‹™å±¤
    â”œâ”€â”€ âœ… æ ¼å¼åŒ–å’Œè¿”å› HTTP éŸ¿æ‡‰
    â””â”€â”€ âœ… è™•ç†è«‹æ±‚ç´šåˆ¥çš„ç•°å¸¸
    """
    
    permission_classes = [IsAuthenticated]
    
    def __init__(self, *args, **kwargs):
        """
        åˆå§‹åŒ–è¦–åœ–ï¼Œæ³¨å…¥æ‰€éœ€çš„æœå‹™ä¾è³´
        
        â•­â”€ ğŸ’‰ ä¾è³´æ³¨å…¥å¯¦è¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ åœ¨è¦–åœ–çš„æ§‹é€ å‡½æ•¸ä¸­æ³¨å…¥æœå‹™ä¾è³´ï¼Œå¸¶ä¾†ä»¥ä¸‹å¥½è™•ï¼š             â”‚
        â”‚ â€¢ æ˜ç¢ºä¾è³´é—œä¿‚ï¼šæ¸…æ¥šåœ°å±•ç¤ºè¦–åœ–éœ€è¦å“ªäº›æœå‹™               â”‚
        â”‚ â€¢ ä¾¿æ–¼æ¸¬è©¦ï¼šå¯ä»¥è¼•é¬†æ³¨å…¥ Mock æœå‹™é€²è¡Œå–®å…ƒæ¸¬è©¦           â”‚
        â”‚ â€¢ é™ä½è€¦åˆï¼šè¦–åœ–ä¸ç›´æ¥ä¾è³´å…·é«”çš„æœå‹™å¯¦ç¾                â”‚
        â”‚ â€¢ éˆæ´»é…ç½®ï¼šå¯ä»¥æ ¹æ“šä¸åŒç’°å¢ƒæ³¨å…¥ä¸åŒçš„æœå‹™å¯¦ç¾           â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        """
        super().__init__(*args, **kwargs)
        # æ³¨å…¥é—œæ³¨æ“ä½œæœå‹™
        self.follow_service = FollowOperationService()
    
    def post(self, request, username=None):
        """
        è™•ç†é—œæ³¨ç”¨æˆ¶çš„ POST è«‹æ±‚
        
        â•­â”€ ğŸŒ HTTP èªç¾© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ POST æ–¹æ³•çš„èªç¾©ï¼š                                      â”‚
        â”‚ â€¢ å‰µå»ºè³‡æºï¼šåœ¨ç³»çµ±ä¸­å‰µå»ºæ–°çš„é—œæ³¨é—œä¿‚                    â”‚
        â”‚ â€¢ éå†ªç­‰æ€§ï¼šå¤šæ¬¡åŸ·è¡Œå¯èƒ½ç”¢ç”Ÿä¸åŒçµæœ                    â”‚
        â”‚ â€¢ ç‹€æ…‹æ”¹è®Šï¼šæ”¹è®Šç³»çµ±çš„ç‹€æ…‹ï¼ˆå¢åŠ é—œæ³¨é—œä¿‚ï¼‰              â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            request: Django HTTP è«‹æ±‚å°è±¡ï¼ŒåŒ…å«è«‹æ±‚ä¿¡æ¯
            username (str): ç›®æ¨™ç”¨æˆ¶çš„ç”¨æˆ¶åï¼Œå¾ URL è·¯å¾‘ä¸­ç²å–
        
        Returns:
            Response: æ¨™æº–åŒ–çš„ HTTP éŸ¿æ‡‰å°è±¡
        
        HTTP Status Codes:
            - 201: é—œæ³¨æˆåŠŸï¼Œå‰µå»ºäº†æ–°çš„é—œæ³¨é—œä¿‚
            - 400: è«‹æ±‚éŒ¯èª¤ï¼Œå¦‚ä¸èƒ½é—œæ³¨è‡ªå·±ã€å·²ç¶“é—œæ³¨ç­‰
            - 404: ç›®æ¨™ç”¨æˆ¶ä¸å­˜åœ¨
            - 500: æœå‹™å™¨å…§éƒ¨éŒ¯èª¤
        """
        # ğŸ“‹ æ­¥é©Ÿ 1ï¼šç²å–ç›®æ¨™ç”¨æˆ¶å°è±¡
        target_user = self._get_target_user_safely(username)
        
        # ğŸ“‹ æ­¥é©Ÿ 2ï¼šå§”è¨—æ¥­å‹™é‚è¼¯çµ¦æœå‹™å±¤
        operation_result = self.follow_service.execute_follow(
            follower=request.user,
            target=target_user
        )
        
        # ğŸ“‹ æ­¥é©Ÿ 3ï¼šæ§‹å»ºä¸¦è¿”å› HTTP éŸ¿æ‡‰
        return Response(
            data={'message': operation_result['message']},
            status=operation_result['status_code']
        )
    
    def _get_target_user_safely(self, username: str) -> User:
        """
        å®‰å…¨åœ°ç²å–ç›®æ¨™ç”¨æˆ¶å°è±¡
        
        â•­â”€ ğŸ›¡ï¸ å®‰å…¨è€ƒé‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
        â”‚ â€¢ è¼¸å…¥é©—è­‰ï¼šç¢ºä¿ç”¨æˆ¶ååƒæ•¸ä¸ç‚ºç©º                        â”‚
        â”‚ â€¢ å­˜åœ¨æ€§æª¢æŸ¥ï¼šç¢ºä¿ç”¨æˆ¶å­˜åœ¨                              â”‚
        â”‚ â€¢ ç•°å¸¸è™•ç†ï¼šçµ±ä¸€çš„éŒ¯èª¤éŸ¿æ‡‰                              â”‚
        â”‚ â€¢ å®‰å…¨æ€§ï¼šé˜²æ­¢SQLæ³¨å…¥ç­‰å®‰å…¨å•é¡Œ                         â”‚
        â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
        
        Args:
            username (str): ç”¨æˆ¶åå­—ç¬¦ä¸²
        
        Returns:
            User: ç›®æ¨™ç”¨æˆ¶å°è±¡
        
        Raises:
            Http404: ç•¶ç”¨æˆ¶ä¸å­˜åœ¨æ™‚æ‹‹å‡º 404 ç•°å¸¸
        """
        if not username or not username.strip():
            raise ValueError("ç”¨æˆ¶åä¸èƒ½ç‚ºç©º")
        
        return get_object_or_404(User, username=username.strip())


# ======================================================================================
# ğŸ“Š ç”¨æˆ¶çµ±è¨ˆè¦–åœ– - å–®ä¸€è·è²¬ï¼šç”¨æˆ¶çµ±è¨ˆæ•¸æ“šå±•ç¤º
# ======================================================================================

@api_view(['GET'])
@permission_classes([AllowAny])
def get_user_statistics(request, username):
    """
    ç²å–æŒ‡å®šç”¨æˆ¶çš„çµ±è¨ˆä¿¡æ¯
    
    â•­â”€ ğŸ“š å­¸ç¿’é‡é» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
    â”‚ â€¢ å‡½æ•¸å¼è¦–åœ–ï¼šé©åˆç°¡å–®çš„ã€å–®ä¸€åŠŸèƒ½çš„ API ç«¯é»              â”‚
    â”‚ â€¢ åªè®€æ“ä½œï¼šåƒ…æä¾›æ•¸æ“šæŸ¥è©¢ï¼Œä¸ä¿®æ”¹ä»»ä½•ç‹€æ…‹                 â”‚
    â”‚ â€¢ å…¬é–‹è¨ªå•ï¼šå…è¨±åŒ¿åç”¨æˆ¶æŸ¥çœ‹åŸºæœ¬çµ±è¨ˆä¿¡æ¯                   â”‚
    â”‚ â€¢ éŸ¿æ‡‰æ¨™æº–åŒ–ï¼šè¿”å›çµæ§‹åŒ–çš„çµ±è¨ˆæ•¸æ“š                         â”‚
    â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
    
    ğŸ¯ è·è²¬ç¯„åœï¼š
    â”œâ”€â”€ âœ… æŸ¥è©¢ç”¨æˆ¶åŸºæœ¬çµ±è¨ˆä¿¡æ¯
    â”œâ”€â”€ âœ… æ ¼å¼åŒ–çµ±è¨ˆæ•¸æ“š
    â”œâ”€â”€ âœ… è¿”å›æ¨™æº–åŒ–éŸ¿æ‡‰
    â””â”€â”€ âœ… è™•ç†ç”¨æˆ¶ä¸å­˜åœ¨çš„æƒ…æ³
    
    Args:
        request: HTTP è«‹æ±‚å°è±¡
        username (str): è¦æŸ¥è©¢çµ±è¨ˆä¿¡æ¯çš„ç”¨æˆ¶å
    
    Returns:
        Response: åŒ…å«ç”¨æˆ¶çµ±è¨ˆæ•¸æ“šçš„ HTTP éŸ¿æ‡‰
    
    Response Format:
        {
            "followers_count": 150,        # ç²‰çµ²æ•¸
            "following_count": 89,         # é—œæ³¨æ•¸
            "posts_count": 45,             # ç™¼æ–‡æ•¸
            "likes_received_count": 1200,  # ç²å¾—è®šæ•¸
            "join_date": "2023-01-15",     # åŠ å…¥æ—¥æœŸ
            "last_active": "2024-01-20",   # æœ€å¾Œæ´»èºæ™‚é–“
            "is_verified": true            # æ˜¯å¦å·²é©—è­‰
        }
    """
    # ğŸ“‹ æ­¥é©Ÿ 1ï¼šç²å–ç›®æ¨™ç”¨æˆ¶
    target_user = get_object_or_404(User, username=username)
    
    # ğŸ“‹ æ­¥é©Ÿ 2ï¼šæ§‹å»ºçµ±è¨ˆæ•¸æ“š
    statistics_data = {
        'followers_count': target_user.followers_count,
        'following_count': target_user.following_count,
        'posts_count': target_user.posts_count,
        'likes_received_count': target_user.likes_received_count,
        'join_date': target_user.date_joined.date(),
        'last_active': target_user.last_online,
        'is_verified': target_user.is_verified,
    }
    
    # ğŸ“‹ æ­¥é©Ÿ 3ï¼šè¿”å›éŸ¿æ‡‰
    return Response(statistics_data, status=status.HTTP_200_OK)


# ======================================================================================
# ğŸ“š é‡æ§‹æˆæœå±•ç¤ºå’Œå­¸ç¿’ç¸½çµ
# ======================================================================================

"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           ğŸ“ Clean Code é‡æ§‹æˆæœç¸½çµ                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ é‡æ§‹å‰ vs é‡æ§‹å¾Œå°æ¯”ï¼š

â”Œâ”€ é‡æ§‹å‰çš„å•é¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ UserViewSet é¡ï¼š661 è¡Œä»£ç¢¼ï¼Œè·è²¬éå¤š                                        â”‚
â”‚ âŒ ä¸€å€‹é¡è™•ç†ï¼šCRUDã€é—œæ³¨ã€æœç´¢ã€æ¨è–¦ã€çµ±è¨ˆç­‰å¤šç¨®åŠŸèƒ½                           â”‚
â”‚ âŒ æ–¹æ³•éé•·ï¼šå–®å€‹æ–¹æ³•è¶…é 50 è¡Œï¼Œé‚è¼¯è¤‡é›œ                                      â”‚
â”‚ âŒ æ¥­å‹™é‚è¼¯æ··é›œï¼šè¦–åœ–é‚è¼¯å’Œæ¥­å‹™é‚è¼¯æ··åˆåœ¨ä¸€èµ·                                  â”‚
â”‚ âŒ æ¸¬è©¦å›°é›£ï¼šé¾å¤§çš„é¡é›£ä»¥é€²è¡Œå–®å…ƒæ¸¬è©¦                                          â”‚
â”‚ âŒ ç¶­è­·å›°é›£ï¼šä¿®æ”¹ä¸€å€‹åŠŸèƒ½å½±éŸ¿å…¶ä»–åŠŸèƒ½                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ é‡æ§‹å¾Œçš„æ”¹é€² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… è·è²¬åˆ†é›¢ï¼š                                                                  â”‚
â”‚    â€¢ UserPermissionChecker      â†’ å°ˆé–€è™•ç†æ¬Šé™æª¢æŸ¥                            â”‚
â”‚    â€¢ FollowOperationService     â†’ å°ˆé–€è™•ç†é—œæ³¨æ¥­å‹™é‚è¼¯                        â”‚
â”‚    â€¢ UserQueryService           â†’ å°ˆé–€è™•ç†æ•¸æ“šæŸ¥è©¢                            â”‚
â”‚    â€¢ UserFollowView             â†’ å°ˆé–€è™•ç†é—œæ³¨ç›¸é—œçš„ HTTP è«‹æ±‚                 â”‚
â”‚                                                                               â”‚
â”‚ âœ… å°å‡½æ•¸è¨­è¨ˆï¼š                                                                â”‚
â”‚    â€¢ æ¯å€‹æ–¹æ³•éƒ½æ§åˆ¶åœ¨ 20 è¡Œä»¥å…§                                               â”‚
â”‚    â€¢ æ¯å€‹å‡½æ•¸åªåšä¸€ä»¶äº‹                                                       â”‚
â”‚    â€¢ å‡½æ•¸å‘½åæ¸…æ™°è¡¨é”æ„åœ–                                                     â”‚
â”‚                                                                               â”‚
â”‚ âœ… ä¾è³´æ³¨å…¥ï¼š                                                                  â”‚
â”‚    â€¢ é€šéæ§‹é€ å‡½æ•¸æ³¨å…¥ä¾è³´                                                     â”‚
â”‚    â€¢ ä¾¿æ–¼å–®å…ƒæ¸¬è©¦å’Œ Mock                                                      â”‚
â”‚    â€¢ é™ä½é¡ä¹‹é–“çš„è€¦åˆåº¦                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ˆ å¸¶ä¾†çš„å…·é«”å¥½è™•ï¼š

â•­â”€ å¯æ¸¬è©¦æ€§æå‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ é‡æ§‹å‰ï¼š                                                                       â”‚
â”‚   def test_user_follow():  # éœ€è¦æ¸¬è©¦æ•´å€‹å·¨å¤§çš„ ViewSet                        â”‚
â”‚       # è¤‡é›œçš„æ¸¬è©¦è¨­ç½®                                                         â”‚
â”‚       # é›£ä»¥éš”é›¢æ¸¬è©¦ç‰¹å®šåŠŸèƒ½                                                   â”‚
â”‚                                                                               â”‚
â”‚ é‡æ§‹å¾Œï¼š                                                                       â”‚
â”‚   def test_permission_check():                                                â”‚
â”‚       checker = UserPermissionChecker()                                      â”‚
â”‚       result = checker.can_follow_user(user1, user2)                         â”‚
â”‚       assert result == (True, None)                                          â”‚
â”‚                                                                               â”‚
â”‚   def test_follow_service():                                                  â”‚
â”‚       service = FollowOperationService()                                     â”‚
â”‚       result = service.execute_follow(follower, target)                      â”‚
â”‚       assert result['success'] is True                                       â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€ å¯ç¶­è­·æ€§æå‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ â€¢ ä¿®æ”¹æ¬Šé™é‚è¼¯ï¼šåªéœ€ä¿®æ”¹ UserPermissionChecker                                 â”‚
â”‚ â€¢ ä¿®æ”¹é—œæ³¨æµç¨‹ï¼šåªéœ€ä¿®æ”¹ FollowOperationService                                â”‚
â”‚ â€¢ ä¿®æ”¹æŸ¥è©¢é‚è¼¯ï¼šåªéœ€ä¿®æ”¹ UserQueryService                                      â”‚
â”‚ â€¢ ä¿®æ”¹ API éŸ¿æ‡‰ï¼šåªéœ€ä¿®æ”¹å°æ‡‰çš„è¦–åœ–é¡                                          â”‚
â”‚                                                                               â”‚
â”‚ æ¯å€‹ä¿®æ”¹éƒ½æœ‰æ˜ç¢ºçš„ç¯„åœï¼Œä¸æœƒæ„å¤–å½±éŸ¿å…¶ä»–åŠŸèƒ½                                   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â•­â”€ å¯é‡ç”¨æ€§æå‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ â€¢ UserPermissionChecker å¯ä»¥åœ¨å…¶ä»–éœ€è¦æ¬Šé™æª¢æŸ¥çš„åœ°æ–¹é‡ç”¨                       â”‚
â”‚ â€¢ FollowOperationService å¯ä»¥åœ¨ä¸åŒçš„ API ç«¯é»ä¸­é‡ç”¨                           â”‚
â”‚ â€¢ UserQueryService å¯ä»¥ç‚ºä¸åŒé¡å‹çš„æŸ¥è©¢æä¾›æœå‹™                                â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

ğŸ¯ å­¸ç¿’åƒ¹å€¼ç¸½çµï¼š

é€šéé€™å€‹é‡æ§‹ç¯„ä¾‹ï¼Œæ‚¨å­¸åˆ°äº†ï¼š

1. ğŸ¯ å¦‚ä½•è­˜åˆ¥é•åå–®ä¸€è·è²¬åŸå‰‡çš„ä»£ç¢¼
   â€¢ çœ‹åˆ°ä¸€å€‹é¡æœ‰å¤šå€‹ä¸ç›¸é—œçš„æ–¹æ³•
   â€¢ ç™¼ç¾ä¸€å€‹æ–¹æ³•åšäº†å¤šä»¶äº‹æƒ…
   â€¢ æ³¨æ„åˆ°ä¿®æ”¹ä¸€å€‹åŠŸèƒ½å½±éŸ¿äº†å…¶ä»–åŠŸèƒ½

2. ğŸ”§ å¦‚ä½•å°‡å¤§é¡æ‹†åˆ†ç‚ºå°çš„å°ˆé–€é¡
   â€¢ æŒ‰æ¥­å‹™é ˜åŸŸåŠƒåˆ†è·è²¬
   â€¢ æ¯å€‹é¡åªé—œæ³¨ä¸€å€‹ç‰¹å®šå•é¡Œ
   â€¢ ä¿æŒé¡çš„ä»‹é¢ç°¡æ½”æ˜ç¢º

3. ğŸ’‰ å¦‚ä½•å¯¦ç¾ä¾è³´æ³¨å…¥æ¨¡å¼
   â€¢ é€šéæ§‹é€ å‡½æ•¸æ³¨å…¥ä¾è³´
   â€¢ ä¾è³´æ–¼æŠ½è±¡æ¥å£è€Œéå…·é«”å¯¦ç¾
   â€¢ æé«˜ä»£ç¢¼çš„å¯æ¸¬è©¦æ€§

4. ğŸ“ å¦‚ä½•è¨­è¨ˆå°è€Œå°ˆæ³¨çš„å‡½æ•¸
   â€¢ ä¸€å€‹å‡½æ•¸åªåšä¸€ä»¶äº‹
   â€¢ æ§åˆ¶å‡½æ•¸çš„è¡Œæ•¸å’Œè¤‡é›œåº¦
   â€¢ ä½¿ç”¨æè¿°æ€§çš„å‡½æ•¸å

5. ğŸ—ï¸ å¦‚ä½•è¨­è¨ˆæ¸…æ™°çš„æœå‹™å±¤æ¶æ§‹
   â€¢ æ¥­å‹™é‚è¼¯èˆ‡è¡¨ç¾å±¤åˆ†é›¢
   â€¢ çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
   â€¢ æ¨™æº–åŒ–çš„éŸ¿æ‡‰æ ¼å¼

é€™äº›æŠ€èƒ½å°‡å¹«åŠ©æ‚¨åœ¨å¯¦éš›é …ç›®ä¸­å¯«å‡ºæ›´é«˜è³ªé‡ã€æ›´æ˜“ç¶­è­·çš„ä»£ç¢¼ï¼
""" 